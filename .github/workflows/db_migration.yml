name: Migrate to TiDB

on:
  workflow_dispatch:

jobs:
  migrate:
    runs-on: ubuntu-latest
    steps:
      - name: Install MySQL Client
        run: |
          sudo apt-get update
          sudo apt-get install -y mysql-client

      - name: Simple Migrate using Python
        env:
          OLD_URI: ${{ secrets.OLD_DB_URI }}
          NEW_URI: ${{ secrets.NEW_DB_URI }}
        run: |
          python3 -c "
          import os, subprocess, sys
          from urllib.parse import urlparse

          def run_migration():
              print('>>> æ­£åœ¨è§£æè¿æ¥ä¿¡æ¯...')
              # è§£ææ—§åº“ (Aiven)
              old = urlparse(os.environ['OLD_URI'])
              
              # è§£ææ–°åº“ (TiDB)
              new = urlparse(os.environ['NEW_URI'])
              # æ³¨æ„: TiDB çš„ URI ä¸­æ•°æ®åº“åé€šå¸¸æ˜¯ /testï¼Œä¼šè‡ªåŠ¨å¯¼å…¥åˆ°é‚£é‡Œ
              target_db = new.path.lstrip('/')

              print(f'>>> æºæ•°æ®åº“: {old.hostname} ({old.path.lstrip("/")})')
              print(f'>>> ç›®æ ‡æ•°æ®åº“: {new.hostname} ({target_db})')

              print('\n>>> [1/2] æ­£åœ¨ä»æ—§åº“å¯¼å‡ºæ•°æ®...')
              # ç®€å•çš„æ•´åº“å¯¼å‡º
              dump_cmd = [
                  'mysqldump',
                  '-h', old.hostname,
                  '-P', str(old.port),
                  '-u', old.username,
                  f'-p{old.password}',
                  '--ssl-mode=REQUIRED',
                  '--single-transaction',
                  '--quick',
                  '--hex-blob',
                  '--set-gtid-purged=OFF', # TiDB å¿…é¡»åŠ è¿™ä¸ª
                  old.path.lstrip('/')
              ]
              
              with open('dump.sql', 'w') as f:
                  subprocess.run(dump_cmd, stdout=f, check=True)
              
              size_mb = os.path.getsize('dump.sql') / 1024 / 1024
              print(f'>>> å¯¼å‡ºå®Œæˆ! æ–‡ä»¶å¤§å°: {size_mb:.2f} MB')

              print('\n>>> [2/2] æ­£åœ¨å¯¼å…¥åˆ° TiDB...')
              # ç®€å•çš„æ•´åº“å¯¼å…¥
              import_cmd = [
                  'mysql',
                  '-h', new.hostname,
                  '-P', str(new.port),
                  '-u', new.username,
                  f'-p{new.password}',
                  '--ssl-mode=REQUIRED',
                  target_db
              ]

              with open('dump.sql', 'r') as f:
                  subprocess.run(import_cmd, stdin=f, check=True)
                  
              print('\n>>> ğŸ‰ æ­å–œï¼æ•°æ®å·²æˆåŠŸè¿ç§»åˆ° TiDBï¼')

          if __name__ == '__main__':
              try:
                  run_migration()
              except Exception as e:
                  print(f'âŒ é”™è¯¯: {e}')
                  sys.exit(1)
          "
