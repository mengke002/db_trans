name: MySQL Stable Migration

on:
  workflow_dispatch:

jobs:
  migrate:
    runs-on: ubuntu-latest
    steps:
      - name: Install MySQL Client
        run: |
          sudo apt-get update
          sudo apt-get install -y mysql-client

      - name: Stable Migrate using Python
        env:
          OLD_URI: ${{ secrets.OLD_DB_URI }}
          NEW_URI: ${{ secrets.NEW_DB_URI }}
        run: |
          python3 -c "
          import os, subprocess, sys, time
          from urllib.parse import urlparse

          def get_connection_args(uri_str):
              u = urlparse(uri_str)
              return {
                  'host': u.hostname,
                  'port': str(u.port),
                  'user': u.username,
                  'password': u.password,
                  'db': u.path.lstrip('/')
              }

          def run_command(cmd, stdin_file=None):
              try:
                  if stdin_file:
                      with open(stdin_file, 'r') as f:
                          subprocess.run(cmd, stdin=f, check=True, text=True, capture_output=True)
                  else:
                      subprocess.run(cmd, check=True, text=True, capture_output=True)
              except subprocess.CalledProcessError as e:
                  print(f'❌ 命令执行失败: {e}')
                  if e.stderr: print(f'错误详情: {e.stderr}')
                  raise

          def migrate():
              old = get_connection_args(os.environ['OLD_URI'])
              new = get_connection_args(os.environ['NEW_URI'])
              
              print('>>> [1/4] 连接旧数据库，获取表清单...')
              list_cmd = [
                  'mysql', '-h', old['host'], '-P', old['port'], '-u', old['user'], f'-p{old['password']}',
                  '--ssl-mode=REQUIRED', '-N', '-e', 'SHOW TABLES', old['db']
              ]
              # 获取表名列表
              try:
                  output = subprocess.run(list_cmd, check=True, text=True, capture_output=True).stdout
                  tables = [t.strip() for t in output.splitlines() if t.strip()]
              except Exception as e:
                  print(f'连接失败，请检查 Secret 配置。详情: {e}')
                  sys.exit(1)
                  
              print(f'>>> 发现 {len(tables)} 张表: {tables}')

              print('\n>>> [2/4] 迁移表结构 (Schema Only)...')
              dump_schema = [
                  'mysqldump', '-h', old['host'], '-P', old['port'], '-u', old['user'], f'-p{old['password']}',
                  '--ssl-mode=REQUIRED', '--single-transaction', '--no-data', '--set-gtid-purged=OFF',
                  old['db']
              ]
              with open('schema.sql', 'w') as f:
                  subprocess.run(dump_schema, stdout=f, check=True)
              
              import_base = [
                  'mysql', '-h', new['host'], '-P', new['port'], '-u', new['user'], f'-p{new['password']}',
                  '--ssl-mode=REQUIRED', new['db']
              ]
              run_command(import_base, stdin_file='schema.sql')
              print('✅ 表结构创建完成')

              print('\n>>> [3/4] 逐表迁移数据 (Stable Mode)...')
              for i, table in enumerate(tables):
                  print(f'>>> [{i+1}/{len(tables)}] 正在迁移表: {table} ...')
                  
                  with open('table_data.sql', 'w') as f:
                      # 仅保留安全的优化指令，去掉导致报错的 SQL_LOG_BIN
                      f.write('SET FOREIGN_KEY_CHECKS=0;\n')
                      f.write('SET AUTOCOMMIT=0;\n') 
                      f.flush()
                      
                      dump_table = [
                          'mysqldump', '-h', old['host'], '-P', old['port'], '-u', old['user'], f'-p{old['password']}',
                          '--ssl-mode=REQUIRED', '--single-transaction', '--hex-blob', '--no-create-info', 
                          '--set-gtid-purged=OFF', old['db'], table
                      ]
                      subprocess.run(dump_table, stdout=f, check=True)
                      
                      f.write('\nCOMMIT;\n')
                      f.flush()

                  # 导入
                  run_command(import_base, stdin_file='table_data.sql')
                  
                  os.remove('table_data.sql')
                  # 休息3秒，让 Aiven 有机会清理 Binlog
                  time.sleep(3)

              print('\n>>> [4/4] ✅ 全部迁移成功！')

          if __name__ == '__main__':
              migrate()
          "
