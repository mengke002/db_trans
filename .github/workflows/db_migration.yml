name: Migrate to TiDB (Fixed)

on:
  workflow_dispatch:

jobs:
  migrate:
    runs-on: ubuntu-latest
    steps:
      - name: Install MySQL Client
        run: |
          sudo apt-get update
          sudo apt-get install -y mysql-client

      - name: Migrate using Python with Fix
        env:
          OLD_URI: ${{ secrets.OLD_DB_URI }}
          NEW_URI: ${{ secrets.NEW_DB_URI }}
        run: |
          cat << 'EOF' > migrate.py
          import os, subprocess, sys
          from urllib.parse import urlparse

          def run_migration():
              print('>>> æ­£åœ¨è§£æè¿æ¥ä¿¡æ¯...')
              old = urlparse(os.environ['OLD_URI'])
              new = urlparse(os.environ['NEW_URI'])
              
              old_db = old.path.lstrip('/')
              target_db = new.path.lstrip('/')

              print(f'>>> æºæ•°æ®åº“: {old.hostname} ({old_db})')
              print(f'>>> ç›®æ ‡æ•°æ®åº“: {new.hostname} ({target_db})')

              print('\n>>> [1/3] æ­£åœ¨ä»æ—§åº“å¯¼å‡ºæ•°æ®...')
              dump_cmd = [
                  'mysqldump',
                  '-h', old.hostname,
                  '-P', str(old.port),
                  '-u', old.username,
                  f'-p{old.password}',
                  '--ssl-mode=REQUIRED',
                  '--single-transaction',
                  '--quick',
                  '--hex-blob',
                  '--set-gtid-purged=OFF',
                  old_db
              ]
              
              with open('dump.sql', 'w') as f:
                  subprocess.run(dump_cmd, stdout=f, check=True)
              
              size_mb = os.path.getsize('dump.sql') / 1024 / 1024
              print(f'>>> å¯¼å‡ºå®Œæˆ! æ–‡ä»¶å¤§å°: {size_mb:.2f} MB')

              # ---------------------------------------------------------
              # å…³é”®ä¿®å¤æ­¥éª¤ï¼šæ›¿æ¢ä¸å…¼å®¹çš„å­—ç¬¦é›†
              # ---------------------------------------------------------
              print('\n>>> [2/3] æ­£åœ¨ä¿®å¤ TiDB å…¼å®¹æ€§é—®é¢˜ (ascii -> utf8mb4)...')
              try:
                  # 1. æŠŠå­—ç¬¦é›† ascii æ›¿æ¢ä¸º utf8mb4
                  subprocess.run(["sed", "-i", "s/CHARACTER SET ascii/CHARACTER SET utf8mb4/g", "dump.sql"], check=True)
                  # 2. æŠŠæ’åºè§„åˆ™ ascii_general_ci æ›¿æ¢ä¸º utf8mb4_general_ci
                  subprocess.run(["sed", "-i", "s/ascii_general_ci/utf8mb4_general_ci/g", "dump.sql"], check=True)
                  print('>>> âœ… SQL æ–‡ä»¶ä¿®å¤å®Œæˆ')
              except Exception as e:
                  print(f'âš ï¸ ä¿®å¤è¿‡ç¨‹å‡ºç°è­¦å‘Š (é€šå¸¸å¯å¿½ç•¥): {e}')

              print('\n>>> [3/3] æ­£åœ¨å¯¼å…¥åˆ° TiDB...')
              import_cmd = [
                  'mysql',
                  '-h', new.hostname,
                  '-P', str(new.port),
                  '-u', new.username,
                  f'-p{new.password}',
                  '--ssl-mode=REQUIRED',
                  target_db
              ]

              with open('dump.sql', 'r') as f:
                  subprocess.run(import_cmd, stdin=f, check=True)
                  
              print('\n>>> ğŸ‰ æ­å–œï¼æ•°æ®å·²æˆåŠŸè¿ç§»åˆ° TiDBï¼')

          if __name__ == '__main__':
              try:
                  run_migration()
              except Exception as e:
                  print(f'âŒ é”™è¯¯: {e}')
                  sys.exit(1)
          EOF

          python3 migrate.py
